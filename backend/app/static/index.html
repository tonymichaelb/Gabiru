<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chroma</title>
  <link rel="stylesheet" href="/static/styles.css?v=16" />
</head>
<body>
  <main class="wrap">
    <header class="bar">
      <h1>Chroma</h1>
      <div class="status" id="connStatus">desconectado</div>
    </header>

    <div class="toast-host" id="toastHost" aria-live="polite" aria-relevant="additions" aria-atomic="false"></div>

    <div class="update-banner" id="updateBanner" style="display:none;">
      <div class="update-banner-text" id="updateBannerText">Nova atualização disponível.</div>
      <button type="button" class="secondary" id="updateReloadBtn">Recarregar</button>
    </div>

    <nav class="tabs" aria-label="Abas">
      <button type="button" class="tab active" data-tab="print" id="tabPrint">Impressão</button>
      <button type="button" class="tab" data-tab="motion" id="tabMotion">Movimento</button>
      <button type="button" class="tab" data-tab="colorir" id="tabColorir">Colorir</button>
      <button type="button" class="tab" data-tab="system" id="tabSystem">Sistema</button>
    </nav>

    <section class="tab-panel" data-tab="print" id="panelPrint">

    <section class="card">
      <h2>Arquivos (.gcode)</h2>
      <div class="row row-upload">
        <input id="uploadInput" type="file" accept=".gcode" />
        <button id="uploadBtn">Upload</button>
        <button id="refreshFilesBtn" class="secondary">Atualizar lista</button>
        <button id="deleteFileBtn" class="danger">Excluir selecionado</button>
      </div>
      <div class="file-browser" aria-label="Arquivos G-code">
        <div class="file-list" id="fileList"></div>
        <div class="file-preview" id="filePreview">
          <div class="muted">Selecione um arquivo para ver a prévia.</div>
        </div>
      </div>

      <div class="row row-job-controls">
        <div class="selected-file">
          <div class="label">Arquivo selecionado</div>
          <div class="value" id="selectedFile">—</div>
        </div>
        <button id="startBtn">Iniciar</button>
        <button id="pauseBtn" class="secondary">Pausar</button>
        <button id="resumeBtn" class="secondary">Retomar</button>
        <button id="cancelBtn" class="danger">Cancelar</button>
      </div>
      <div class="row row-job-status">
        <div class="kv"><span>Job:</span> <span id="jobFile">—</span></div>
        <div class="kv"><span>Estado:</span> <span id="jobState">—</span></div>
        <div class="kv"><span>Progresso:</span> <span id="jobProgress">0%</span></div>
        <div class="kv"><span>Hotend:</span> <span id="hotend">—</span></div>
        <div class="kv"><span>Bed:</span> <span id="bed">—</span></div>
      </div>
    </section>

    <section class="card">
      <h2>Time-lapse</h2>
      <div class="row row-timelapse">
        <button id="tlStartBtn">Iniciar</button>
        <button id="tlStopBtn" class="secondary">Parar e gerar vídeo</button>
        <button id="tlRefreshBtn" class="secondary">Atualizar lista</button>
        <a id="tlLastLink" class="btn-link" href="#" target="_blank" rel="noreferrer">Baixar último</a>
      </div>
      <div class="timelapse-live">
        <div class="label">Ao vivo</div>
        <img id="tlLiveImg" class="timelapse-live-img" alt="Prévia ao vivo" />
        <div id="tlLiveHint" class="muted">Inicie o time-lapse para ver a prévia ao vivo.</div>
      </div>
      <div class="timelapse-meta" id="tlMeta"></div>
      <div class="timelapse-list" id="tlList"></div>
    </section>

    </section>

    <section class="tab-panel hidden" data-tab="motion" id="panelMotion">

    <section class="card">
      <h2>Movimento</h2>

      <div class="row row-jog-settings">
        <label>
          Passo (mm)
          <select id="jogStep">
            <option value="0.1">0.1</option>
            <option value="1" selected>1</option>
            <option value="10">10</option>
          </select>
        </label>
        <button id="homeBtn">Home (G28)</button>
        <button id="g29Btn" class="secondary">G29 (Auto level)</button>
      </div>

      <div class="jog-grid" aria-label="Movimento X e Y">
        <div></div>
        <button id="jogYPos" class="secondary">Y+</button>
        <div></div>
        <button id="jogXNeg" class="secondary">X-</button>
        <div class="muted jog-center">XY</div>
        <button id="jogXPos" class="secondary">X+</button>
        <div></div>
        <button id="jogYNeg" class="secondary">Y-</button>
        <div></div>
      </div>

      <div class="jog-z" aria-label="Movimento Z">
        <button id="jogZUp" class="secondary">Z+</button>
        <button id="jogZDown" class="secondary">Z-</button>
      </div>
    </section>

    <section class="card">
      <h2>PID</h2>

      <div class="row row-pid" aria-label="PID Hotend">
        <label>
          Hotend alvo (°C)
          <input id="pidHotendTemp" type="number" min="0" max="320" step="1" value="200" />
        </label>
        <label>
          Ciclos
          <input id="pidHotendCycles" type="number" min="1" max="20" step="1" value="5" />
        </label>
        <button id="pidHotendBtn">PID Hotend</button>
      </div>

      <div class="row row-pid" aria-label="PID Mesa">
        <label>
          Mesa alvo (°C)
          <input id="pidBedTemp" type="number" min="0" max="150" step="1" value="60" />
        </label>
        <label>
          Ciclos
          <input id="pidBedCycles" type="number" min="1" max="20" step="1" value="5" />
        </label>
        <button id="pidBedBtn" class="secondary">PID Mesa</button>
      </div>

      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Executa M303 (Marlin). Os resultados aparecem no Terminal.
      </div>
    </section>

    <section class="card">
      <h2>Temperatura</h2>
      <div class="row row-temp">
        <label>
          Hotend (°C)
          <input id="hotendSet" type="number" min="0" max="320" step="1" placeholder="Ex.: 200" />
        </label>
        <label>
          Bed (°C)
          <input id="bedSet" type="number" min="0" max="150" step="1" placeholder="Ex.: 60" />
        </label>
        <button id="setTempBtn">Aplicar</button>
        <button id="hotendOffBtn" class="secondary">Hotend OFF</button>
        <button id="bedOffBtn" class="secondary">Bed OFF</button>
        <button id="allOffBtn" class="danger">Tudo OFF</button>
      </div>
      <div class="row row-temp-hint">
        <div class="muted">Usa M104/M140 (não espera aquecer). Status atual em "Hotend/Bed".</div>
      </div>
    </section>

    <section class="card">
      <h2>Extrusão / Retração</h2>
      <div class="row row-extrude">
        <label>
          Entrada de filamento (T)
          <select id="extruderTool">
            <option value="0" selected>T0</option>
            <option value="1">T1</option>
            <option value="2">T2</option>
            <option value="3">T3</option>
            <option value="4">T4</option>
            <option value="5">T5</option>
            <option value="6">T6</option>
            <option value="7">T7</option>
            <option value="8">T8</option>
            <option value="9">T9</option>
            <option value="10">T10</option>
            <option value="11">T11</option>
            <option value="12">T12</option>
            <option value="13">T13</option>
            <option value="14">T14</option>
            <option value="15">T15</option>
            <option value="16">T16</option>
            <option value="17">T17</option>
            <option value="18">T18</option>
          </select>
        </label>
        <label>
          Distância (mm)
          <input id="extrudeAmount" type="number" min="1" max="100" step="1" value="10" />
        </label>
        <label>
          Velocidade (mm/s)
          <input id="extrudeSpeed" type="number" min="1" max="50" step="1" value="5" />
        </label>
        <button id="extrudeBtn">Extruir</button>
        <button id="retractBtn" class="secondary">Retrair</button>
      </div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Para 1 bico com várias entradas: seleciona T0–T18 e depois extrude/retire. Certifique-se de que o hotend está aquecido.
      </div>
    </section>

    </section>

    <section class="tab-panel hidden" data-tab="colorir" id="panelColorir">

    <section class="card">
      <h2>Colorir</h2>

      <div class="row" id="pincelButtons" aria-label="Pincéis (T0–T18)">
        <button type="button" class="secondary pincel-btn" data-pincel-tool="0">Pincel 0</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="1">Pincel 1</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="2">Pincel 2</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="3">Pincel 3</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="4">Pincel 4</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="5">Pincel 5</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="6">Pincel 6</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="7">Pincel 7</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="8">Pincel 8</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="9">Pincel 9</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="10">Pincel 10</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="11">Pincel 11</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="12">Pincel 12</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="13">Pincel 13</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="14">Pincel 14</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="15">Pincel 15</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="16">Pincel 16</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="17">Pincel 17</button>
        <button type="button" class="secondary pincel-btn" data-pincel-tool="18">Pincel 18</button>
      </div>

      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Selecione um pincel para trabalhar. Requer conexão no WebSocket.
      </div>
    </section>

    <section class="card">
      <h2>Ajuda</h2>
      <div class="muted" style="font-size: 12px;">
        1) Clique em um <b>Pincel</b> (0–18) para selecionar onde vai aplicar a cor.<br />
        2) Clique em uma <b>Tinta</b> (1–19) para escolher a cor/mistura daquela tinta.<br />
        3) Para trocar a cor de uma tinta, use o seletor de cor ao lado dela.<br />
        4) Para ajustar a mistura, selecione a tinta e use <b>Mistura</b> (A/B/C). O total precisa dar <b>100%</b>.
      </div>
    </section>

    <section class="card">
      <h2>Tintas</h2>
      <div class="row" id="tintaButtons" aria-label="Tintas">
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="1" data-gcode="M182 A0 B0 C100">1</button>
          <input type="color" class="tinta-color" data-tinta-id="1" aria-label="Cor da tinta 1" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="2" data-gcode="M182 A100 B0 C0">2</button>
          <input type="color" class="tinta-color" data-tinta-id="2" aria-label="Cor da tinta 2" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="3" data-gcode="M182 A0 B100 C0">3</button>
          <input type="color" class="tinta-color" data-tinta-id="3" aria-label="Cor da tinta 3" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="4" data-gcode="M182 A80 B0 C20">4</button>
          <input type="color" class="tinta-color" data-tinta-id="4" aria-label="Cor da tinta 4" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="5" data-gcode="M182 A90 B0 C10">5</button>
          <input type="color" class="tinta-color" data-tinta-id="5" aria-label="Cor da tinta 5" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="6" data-gcode="M182 A40 B0 C60">6</button>
          <input type="color" class="tinta-color" data-tinta-id="6" aria-label="Cor da tinta 6" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="7" data-gcode="M182 A15 B0 C85">7</button>
          <input type="color" class="tinta-color" data-tinta-id="7" aria-label="Cor da tinta 7" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="8" data-gcode="M182 A20 B10 C70">8</button>
          <input type="color" class="tinta-color" data-tinta-id="8" aria-label="Cor da tinta 8" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="9" data-gcode="M182 A0 B40 C60">9</button>
          <input type="color" class="tinta-color" data-tinta-id="9" aria-label="Cor da tinta 9" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="10" data-gcode="M182 A0 B25 C75">10</button>
          <input type="color" class="tinta-color" data-tinta-id="10" aria-label="Cor da tinta 10" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="11" data-gcode="M182 A10 B80 C10">11</button>
          <input type="color" class="tinta-color" data-tinta-id="11" aria-label="Cor da tinta 11" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="12" data-gcode="M182 A50 B50 C0">12</button>
          <input type="color" class="tinta-color" data-tinta-id="12" aria-label="Cor da tinta 12" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="13" data-gcode="M182 A70 B20 C10">13</button>
          <input type="color" class="tinta-color" data-tinta-id="13" aria-label="Cor da tinta 13" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="14" data-gcode="M182 A33 B33 C34">14</button>
          <input type="color" class="tinta-color" data-tinta-id="14" aria-label="Cor da tinta 14" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="15" data-gcode="M182 A85 B0 C15">15</button>
          <input type="color" class="tinta-color" data-tinta-id="15" aria-label="Cor da tinta 15" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="16" data-gcode="M182 A20 B0 C80">16</button>
          <input type="color" class="tinta-color" data-tinta-id="16" aria-label="Cor da tinta 16" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="17" data-gcode="M182 A70 B10 C20">17</button>
          <input type="color" class="tinta-color" data-tinta-id="17" aria-label="Cor da tinta 17" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="18" data-gcode="M182 A33 B33 C34">18</button>
          <input type="color" class="tinta-color" data-tinta-id="18" aria-label="Cor da tinta 18" />
        </div>
        <div class="tinta-item">
          <button type="button" class="secondary round-btn" data-tinta-id="19" data-gcode="M182 A20 B10 C70">19</button>
          <input type="color" class="tinta-color" data-tinta-id="19" aria-label="Cor da tinta 19" />
        </div>
      </div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Clique para selecionar e aplicar uma tinta.
      </div>
    </section>

    <section class="card">
      <h2>Mistura</h2>
      <div class="muted" id="tintaMixHint" style="margin-bottom: 10px; font-size: 12px;">
        Selecione uma tinta (1–19) para ajustar A (azul), B (vermelho), C (amarelo) em %.
      </div>
      <div class="row row-mix">
        <div class="kv"><span>Tinta:</span> <span id="tintaMixSelected">—</span></div>
        <label>
          A (azul) %
          <input id="mixA" type="number" min="0" max="100" step="1" value="33" />
        </label>
        <label>
          B (vermelho) %
          <input id="mixB" type="number" min="0" max="100" step="1" value="33" />
        </label>
        <label>
          C (amarelo) %
          <input id="mixC" type="number" min="0" max="100" step="1" value="33" />
        </label>
        <button id="mixApplyBtn">Aplicar na tinta</button>
      </div>

      <div class="kv" style="margin-top: 10px;">
        <span>Total:</span> <span id="mixTotal">—</span>
      </div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Isso atualiza a tinta selecionada (o que ela aplica quando você clicar nela).
      </div>
    </section>

    </section>

    <section class="tab-panel hidden" data-tab="system" id="panelSystem">

    <section class="card">
      <h2>Conexão</h2>
      <div class="row">
        <div class="muted" id="fixedPortLabel" style="display:none; align-self: center;">Porta: /dev/ttyACM0</div>
        <button id="connectBtn">Conectar</button>
        <button id="disconnectBtn" class="secondary">Desconectar</button>
      </div>
    </section>

    <section class="card">
      <h2>Wi‑Fi</h2>
      <div class="muted" id="wifiStatusLabel" style="margin-top: 4px;">Status: —</div>
      <div class="row" style="margin-top: 10px;">
        <button id="wifiScanBtn" class="secondary">Buscar redes</button>
        <select id="wifiSsidSelect" style="min-width: 240px;"></select>
      </div>
      <div class="row" style="margin-top: 10px;">
        <input id="wifiPassword" type="password" placeholder="Senha (se houver)" />
        <button id="wifiConnectBtn">Conectar</button>
      </div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        Se estiver em modo hotspot, ao conectar no Wi‑Fi o hotspot pode desligar.
      </div>
    </section>

    <section class="card">
      <h2>Atualização</h2>
      <div class="row">
        <button id="updateNowBtn" class="secondary">Atualizar agora</button>
      </div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        No Raspberry: executa o auto-update (git pull + reinicia o serviço).
      </div>
      <pre class="terminal" id="updateLog" style="margin-top: 10px; max-height: 200px; overflow: auto;"></pre>
    </section>

    <section class="card">
      <h2>Filamento</h2>
      <div class="muted" id="filamentStatusLabel" style="margin-top: 4px;">Status: —</div>
      <div class="muted" style="margin-top: 8px; font-size: 12px;">
        GPIO17 (pino 11). Aberto = com filamento. Fechado = sem filamento.
      </div>
    </section>

    <section class="card">
      <h2>Terminal</h2>
      <div class="row">
        <input id="cmdInput" placeholder="Ex.: M105" />
        <button id="sendBtn">Enviar</button>
        <button id="pollBtn" class="secondary">Status</button>
      </div>
      <pre class="terminal" id="terminal"></pre>
    </section>

    <section class="card">
      <h2>Conta</h2>
      <div class="row" style="align-items: center;">
        <div class="muted" id="accountUserLabel">Usuário: —</div>
        <button id="logoutBtn" class="secondary">Sair</button>
      </div>

      <div class="row" style="margin-top: 10px;">
        <div class="muted" id="accountHint" style="font-size: 12px;">Você precisa estar logado para gerenciar conta e usuários.</div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <label style="min-width: 260px;">
          Senha atual
          <input id="pwCurrent" type="password" />
        </label>
        <label style="min-width: 260px;">
          Nova senha
          <input id="pwNew" type="password" />
        </label>
        <label style="min-width: 260px;">
          Confirmar nova senha
          <input id="pwNewConfirm" type="password" />
        </label>
        <button id="changePwBtn">Trocar senha</button>
      </div>

      <div class="row" style="margin-top: 14px;">
        <label style="min-width: 220px;">
          Novo usuário
          <input id="newUserName" placeholder="Ex.: maria" />
        </label>
        <label style="min-width: 240px;">
          Senha
          <input id="newUserPw" type="password" />
        </label>
        <label style="min-width: 260px;">
          Confirmar senha
          <input id="newUserPwConfirm" type="password" />
        </label>
        <button id="createUserBtn" class="secondary">Criar usuário</button>
      </div>

      <div class="row" style="margin-top: 14px;">
        <button id="resetUsersBtn" class="danger">Resetar usuários (apagar todos)</button>
        <div class="muted" style="font-size: 12px;">Ação perigosa. Só funciona se GABIRU_ALLOW_USER_RESET=1 estiver habilitado.</div>
      </div>
    </section>

    </section>
  </main>

  <footer class="footer" aria-label="Rodapé">
    <div class="footer-left">
      <span class="footer-app">Gabiru</span>
      <span class="footer-sep">•</span>
      <span class="footer-version" id="footerVersion">versão —</span>
    </div>
  </footer>

  <script src="/static/app.js?v=28"></script>
</body>
</html>
